name: systori

layers:
  base:
    from: damoti/base:latest
    apt-get:
      - language-pack-de
      - libpq-dev
      - postgresql-client
      - libjpeg-dev
      - libxml2-dev
      - libxslt-dev
      - libffi-dev
    context:
      - requirements/base.pip
    build:
      - pip3 install -r requirements/base.pip
  app:
    context:
      - .
    build:
      - cd systori/dart && pub get && pub build && cd -
      - pip3 install --src=/src -r requirements/app.pip
      - export DJANGO_SETTINGS_MODULE=systori.settings.common
      - python3 manage.py collectstatic --noinput
    prepare: fab prepare:service={service},branch={git-branch}
    start: fab start
  test:
    build:
      - pip3 install -r requirements/test.pip
    start: fab test

ssh:
  known_hosts:
    - github.com
    - bitbucket.org
