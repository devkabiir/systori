{% extends "project.html" %}
{% load i18n staticfiles %}

{% block title %}{{ project.name }} > {{ job.name }}{% endblock %}
{% block head_navbar %}
<ul class="nav navbar-nav navbar-left">
  <li><a href="{% url 'project.view' project.id %}">{{ project.name }}</a></li>
  <li class="active"><a href="{% url 'tasks' project.id job.id %}">{{ job.name }}</a></li>
</ul>
{% endblock %}

{% block sidebar %}{% include "project/sidebar.html" with section='jobs' %}{% endblock %}

{% block content %}
<style>

#task-editor {
}

.editor {
  margin-bottom: 10px;
}

.editor-row {
  display: flex;
}

/* task group & task */

.code {
  width: 60px;
}

.description {
  margin-left: 60px;
  width: 440px;
}

.qty {
  width: 70px;
  text-align: right;
}

.unit {
  width: 70px;
  padding-left: 4px;
}

.price {
  width: 70px;
  text-align: right;
}

.total {
  width: 70px;
  font-weight: bold;
  text-align: right;
}

/* task group */

ubr-taskgroup > .editor .name {
  font-weight: bold;
  width: 510px;
}

ubr-taskgroup > .editor .total {
  width: 100px;
}

/* task */

ubr-task > .editor .name {
  width: 330px;
}

/* line item */

ubr-lineitem .name {
  width: 310px;
  margin-left: 80px;
}

div[contenteditable][placeholder]:empty:before {
  content: attr(placeholder);
  font-style: italic;
  color: #d9d9d9;
}

div[contenteditable][placeholder]:empty:focus:before {
  content: "";
}

.autocomplete {
  display: none;
  position: absolute;
  background: white;
}
</style>


<div id="task-editor"
  data-job-pk="{{ job.pk }}"
  data-job-code="{{ job.code }}"
  data-taskgroup-zfill="{{ project.taskgroup_zfill }}"
  data-task-zfill="{{ project.task_zfill }}">


{% for group in object_list %}
<ubr-taskgroup data-pk="{{ group.pk }}">
  <div class="editor">
    <div class="editor-row">
      <div class="code">{{ group.code }}</div>
      <div class="name" placeholder="{% trans 'task group' %}" contenteditable>{{ group.name }}</div>
      <div class="total">{{ group.estimate_total|floatformat:2 }}</div>
    </div>
    <div class="autocomplete"></div>
    <div class="description" placeholder="{% trans 'description' %}" contenteditable>{{ group.description }}</div>
  </div>

  {% for task in group.tasks.all %}
  <ubr-task data-pk="{{ task.pk }}">
    <div class="editor">
      <div class="editor-row">
        <div class="code">{{ task.code }}</div>
        <div class="name" placeholder="{% trans 'task' %}" contenteditable>{{ task.name }}</div>
        <div class="qty" placeholder="{% trans 'qty' %}" contenteditable>{{ task.qty|floatformat:2 }}</div>
        <div class="unit" placeholder="{% trans 'unit' %}" contenteditable>{{ task.unit }}</div>
        <div class="price">{{ task.unit_price|floatformat:2 }}</div>
        <div class="total">{{ task.fixed_price_estimate|floatformat:2 }}</div>
      </div>
      <div class="autocomplete"></div>
      <div class="description" placeholder="{% trans 'description' %}" contenteditable>{{ task.description }}</div>
    </div>

    {% for lineitem in task.lineitems.all %}
    <ubr-lineitem data-pk="{{ lineitem.pk }}">
      <div class="editor">
        <div class="editor-row">
          <div class="name" placeholder="{% trans 'line item' %}" contenteditable>{{ lineitem.name }}</div>
          <div class="qty" placeholder="{% trans 'qty' %}" contenteditable>{{ lineitem.unit_qty|floatformat:2 }}</div>
          <div class="unit" placeholder="{% trans 'unit' %}" contenteditable>{{ lineitem.unit }}</div>
          <div class="price" placeholder="{% trans 'price' %}" contenteditable>{{ lineitem.price|floatformat:2 }}</div>
          <div class="total">{{ lineitem.price_per_task_unit|floatformat:2 }}</div>
        </div>
      </div>
    </ubr-lineitem>
    {% endfor %}

  </ubr-task>
  {% endfor %}

</ubr-taskgroup>
{% endfor %}

</div>

<template id="taskgroup-template">
  <div class="editor">
    <div class="editor-row">
      <div class="code"></div>
      <div class="name" placeholder="{% trans 'task group' %}" contenteditable></div>
      <div class="total"></div>
    </div>
    <div class="autocomplete"></div>
    <div class="description" placeholder="{% trans 'description' %}" contenteditable></div>
  </div>
</template>

<template id="task-template">
  <div class="editor">
    <div class="editor-row">
      <div class="code"></div>
      <div class="name" placeholder="{% trans 'task' %}" contenteditable></div>
      <div class="qty" placeholder="{% trans 'qty' %}" contenteditable></div>
      <div class="unit" placeholder="{% trans 'unit' %}" contenteditable></div>
      <div class="price"></div>
      <div class="total"></div>
    </div>
    <div class="autocomplete"></div>
    <div class="description" placeholder="{% trans 'description' %}" contenteditable></div>
  </div>
</template>

<template id="lineitem-template">
  <div class="editor">
    <div class="editor-row">
      <div class="name" placeholder="{% trans 'line item' %}" contenteditable></div>
      <div class="qty" placeholder="{% trans 'qty' %}" contenteditable></div>
      <div class="unit" placeholder="{% trans 'unit' %}" contenteditable></div>
      <div class="price" placeholder="{% trans 'price' %}" contenteditable></div>
      <div class="total"></div>
    </div>
  </div>
</template>

{% endblock content %}

{% block extra_js%}
<script type="application/dart" src="{% static "editor/editor.dart" %}"></script>
{% endblock extra_js%}