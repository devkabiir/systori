{% extends "project.html" %}
{% load i18n l10n static dartium customformatting %}

{% block title %}{{ project.name }} > {{ job.name }}{% endblock %}
{% block head_navbar %}
  <li><a href="{% url 'project.view' project.pk %}">{{ project.name }}</a></li>
  <li class="active"><a href="{% url 'tasks' project.pk job.pk %}">{{ job.name }}</a></li>
{% endblock %}
{% block sidebar %}
  {% include "project/sidebar.html" with section='jobs' %}
{% endblock %}

{% block content %}
  <style>

    @media (min-width: 1200px) {
      .main {
        width: 970px;
      }
    }

    sys-job,
    sys-group,
    sys-task,
    sys-lineitem {
      display: block;
      position: relative;
      margin-right: 15px;
    }

    sys-job,
    sys-group {
      border-right: 1px solid #e9e9e9;
    }

    sys-job > .editor,
    sys-group > .editor,
    sys-task > .editor {
      position: relative;
      padding-bottom: 10px;
    }

    .editor-row {
      display: flex;
    }

    /* job, group, task */

    .code {
      flex: 0 1 auto;
      font-family: monospace;
    }

    .name {
      flex: 1 1 auto;
      margin: 0 10px 0 10px;
    }

    .total {
      flex: 0 1 auto;
      font-weight: bold;
      text-align: right;
      padding: 0 4px 0 4px;
      margin-right: -5px;
      border: 1px solid black;
      background-color: #fff;
      z-index: 2;
    }

    .description {
      margin-left: 50px;
      padding-top: 20px;
      padding-bottom: 20px;
    }

    sys-group > .editor .name {
      font-weight: bold;
    }

    sys-group > .editor .total:after,
    sys-task > .editor .total:after {
      display: block;
      position: absolute;
      content: "+";

      width: 11px;
      height: 10px;

      top: 0px;
      right: -16px;

      color: #e9e9e9;
      font-size: 9px;
      text-align: left;

      padding-left: 2px;
      border-bottom: 1px solid #e9e9e9;
    }

    /* cover up end of line when last child */
    sys-group:last-child:after,
    sys-task:last-child:after {
      display: block;
      position: absolute;
      content: "";
      width: 3px;
      top: 10px;
      bottom: 0px;
      right: -17px;
      background-color: white;
    }

    /* cover up line if empty group */
    sys-group > .editor:only-child:after {
      display: block;
      position: absolute;
      content: "";
      width: 1px;
      top: 0px;
      bottom: 0px;
      right: -1px;
      background-color: white;
    }

    /* task, lineitem */

    sys-task {
      padding-bottom: 20px;
    }

    .qty {
      flex: 0 0 auto;
      width: 60px;
      text-align: right;
    }

    .unit {
      flex: 0 0 auto;
      width: 60px;
      padding-left: 4px;
    }

    sys-lineitem > .editor .total,
    .price {
      flex: 0 0 auto;
      width: 80px;
      text-align: right;
      padding-right: 4px;
      background-color: #fff;
    }

    sys-lineitem > .editor .total {
      border: 1px solid #e9e9e9;
    }

    sys-task > .editor .price {
      position: relative;
      font-weight: bold;
      border: 1px solid black;
      margin-left: 10px;
    }

    sys-task > .editor .price:before {
      display: block;
      position: absolute;
      content: "x";
      width: 180px;
      height: 1px;
      padding-right: 2px;
      border-top: 1px solid #e9e9e9;
      top: -1px;
      left: -181px;
      color: #e9e9e9;
      font-size: 8px;
      text-align: right;
    }

    sys-task > .editor .price:after {
      display: block;
      position: absolute;
      content: "=";
      width: 10px;
      padding-left: 2px;
      border-top: 1px solid #e9e9e9;
      top: 1px;
      right: -11px;
      color: #e9e9e9;
      font-size: 8px;
      text-align: left;
    }

    sys-task > .editor .total {
      width: 90px;
      margin-left: 10px;
    }

    sys-task > .editor:not(:only-child):after {
      display: block;
      position: absolute;
      content: "";
      width: 1px;
      top: 0px;
      bottom: 0px;
      right: 100px;
      border-right: 1px solid #e9e9e9;
      z-index: -1;
    }

    sys-lineitem:not(:last-child):after {
      display: block;
      position: absolute;
      content: "";
      width: 1px;
      top: 0px;
      bottom: 0px;
      right: 85px;
      border-right: 1px solid #e9e9e9;
      z-index: -1;
    }

    sys-job > .editor .description {
      margin-right: 180px;
    }
    sys-job > sys-group > .editor .description {
      margin-right: 165px;
    }
    sys-job > sys-group > sys-group > .editor .description {
      margin-right: 150px;
    }
    sys-job > sys-group > sys-group > sys-group > .editor .description {
      margin-right: 135px;
    }
    sys-job > sys-group > sys-group > sys-group > sys-group > .editor .description {
      margin-right: 120px;
    }
    sys-task > .editor .description {
      margin-right: 105px;
    }

    /* labels */

    .labels {
      width: 85px;
      padding-left: 20px;
    }

    .labels > .label:hover {
      cursor: pointer;
    }

    .labels > .label.False {
      display: none;
      background-color: #f0f0f0;
    }

    .editor:hover > .editor-row > .labels > .label.False {
      display: inline;
    }

    /* line item */

    sys-lineitem {
      background-color: white;
    }

    sys-lineitem > a {
      position: absolute;
      top: -150px;
    }

    sys-lineitem .price[contenteditable="false"] {
      font-weight: bold;
    }

    sys-lineitem,
    .sys-lineitem-placeholder {
      margin-bottom: 10px;
    }

    .sys-lineitem-handle {
      cursor: pointer;
    }

    sys-lineitem-container {
      -webkit-user-select: none;
      user-select: none;
      margin-left: 100px;
      display: block;
      position: relative;
    }

    sys-lineitem-container:after {
      display: block;
      position: absolute;
      content: "";
      width: 1px;
      top: 0px;
      bottom: 0px;
      right: 100px;
      border-right: 1px solid #e9e9e9;
      z-index: -1;
    }


    div[contenteditable][placeholder]:empty:before {
      content: attr(placeholder);
      font-style: italic;
      color: #d9d9d9;
    }

    div[contenteditable][placeholder]:empty:focus:before {
      content: "";
    }


    sys-autocomplete {
      z-index: 100;
      display: none;
      position: absolute;
      background: white;
      left: 80px;
      width: 480px;
      border: 1px solid lightgrey;
      top: 20px;
      -webkit-transition: top 0.1s;
      -moz-transition: top 0.1s;
      -ms-transition: top 0.1s;
      -o-transition: top 0.1s;
      transition: top 0.1s;
    }

    sys-autocomplete > div {
      border-bottom: 1px solid lightgrey;
    }

    sys-autocomplete > div.active {
      background: orange;
    }

  </style>

  <sys-job id="task-editor" data-pk="{{ job.pk }}" data-code="{{ job.code }}"
           data-structure-format="{{ job.project.structure_format }}">
    {% include "task/editor/group_editor.html" with group=job %}
    {% for group in job.groups.all %}
      {% include "task/editor/group_loop.html" with group=group %}
    {% endfor %}
    {% for task in job.tasks.all %}
      {% include "task/editor/task_loop.html" with task=task %}
    {% endfor %}
  </sys-job>

  <template id="group-template">
    {% include "task/editor/group_editor.html" with group=blank_group %}
  </template>

  <template id="task-template">
    {% include "task/editor/task_editor.html" with task=blank_task %}
  </template>

  <template id="lineitem-template">
    {% include "task/editor/lineitem_editor.html" with lineitem=blank_lineitem %}
  </template>

{% endblock content %}

{% block extra_js %}
  {% dart "job_editor.dart" %}
{% endblock extra_js %}
