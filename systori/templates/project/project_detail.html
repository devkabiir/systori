{% extends "project.html" %}
{% load i18n l10n customformatting project %}

{% block content %}
  <table class="table table-striped">
  <tbody>
    <tr>
      <td>
        <div class="pull-right">
          {% project_states as states %}
          {% for name, label, is_current, transition in states %}
            <a {% if transition %}href="{% url 'project.transition.state' project.id transition %}"{% endif %}
               class="btn btn-xs btn-{% if is_current %}success{% else %}primary{% endif %} {% if is_current %}active{% endif %}{% if not transition and not is_current %}disabled{% endif %}"
                >{{ label }}</a>
          {% endfor %}

          &nbsp; &nbsp; &nbsp; &nbsp;

          {% project_phases as phases %}
          {% for name, label, is_current, is_past, transition in phases %}
            <a {% if transition %}href="{% url 'project.transition.phase' project.id transition %}"{% endif %}
               class="btn btn-xs btn-{% if is_past %}default{% elif is_current %}success{% else %}primary{% endif %} {% if is_current %}active{% endif %}{% if not transition and not is_current %}disabled{% endif %}"
                >{{ label }}</a>
          {% endfor %}
        </div>
      </td>
    </tr>
    {% if project_has_billable_contact %}
    <tr>
      <td>
        <div class="btn-group pull-right" role="group">
          <a type="button" class="btn btn-default" href="{% url 'project.progress' project.id %}">{% trans "Project Progress" %}</a>
          <a type="button" class="btn btn-default" href="{% url 'evidence.pdf' project.id %}">{% trans "Evidence preprinted form" %}</a>
        </div>
      </td>
    </tr>
    {% endif %}
  </tbody>
  </table>

  <h2 class="sub-header">{% trans "Jobs" %}</h2>
  <table class="table table-striped">
    <thead>
    <tr>
      <th>{% trans "Name" %}</th>
      <th>{% trans "Status" %}</th>
      <th style="text-align: right;">{% trans "Total" %}</th>
      <th></th>
      <th>{% trans "Billing Method" %}</th>
      <th style="text-align: right;">{% trans "Billable Amount" %}</th>
      <th style="text-align: right;">{% trans "Actions" %}</th>
    </tr>
    </thead>
    <tbody id="job-table">
    {% for job in project.jobs.all %}
      <tr>
        <td><a href="{% url 'tasks' project.id job.id %}">{{ job.code }} {{ job }}</a></td>
        <td>{{ job.get_status_display }}</td>
        <td style="text-align: right; white-space: nowrap;">
          {{ job.estimate_total|money }}
        </td>
        <td>
          <div class="btn-group">
            <a class="btn btn-default btn-xs" href="{% url 'job.estimate' project.id job.id 'increase' %}"
               title="{% blocktrans with percent=job.ESTIMATE_INCREMENT_DISPLAY %}Increase estimate by {{ percent }}.{% endblocktrans %}"><span
                class="glyphicon glyphicon-plus" aria-hidden="true"></span></a>
            <a class="btn btn-default btn-xs" href="{% url 'job.estimate' project.id job.id 'decrease' %}"
               title="{% blocktrans with percent=job.ESTIMATE_INCREMENT_DISPLAY %}Decrease estimate by {{ percent }}.{% endblocktrans %}"><span
                class="glyphicon glyphicon-minus" aria-hidden="true"></span></a>
            <a class="btn btn-default btn-xs" href="{% url 'job.estimate' project.id job.id 'reset' %}"
               title="{% trans 'Reset estimate to original amount.' %}"><span class="glyphicon glyphicon-unchecked"
                                                                              aria-hidden="true"></span></a>
          </div>
        </td>
        <td>{{ job.get_billing_method_display }}</td>
        <td style="text-align: right; white-space: nowrap;">{{ job.billable_total|money }}</td>
        <td style="text-align: right;">
          {% for state in job.get_available_status_transitions %}
            <a href="{% url 'job.transition' project.id job.id state.name %}">{{ state.custom.label }}</a>
          {% endfor %}
          {% if job.status == job.DRAFT %}
            <a href="{% url 'job.edit' project.id job.id %}">{% trans "Edit" %}</a>
            <a href="{% url 'job.delete' project.id job.id %}">{% trans "Delete" %}</a>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    {% if project.jobs.count > 1 %}
      <tr>
        <td></td>
        <td></td>
        <td style="text-align: right;"><b>{{ project.estimate_total|money }}</b></td>
        <td></td>
        <td></td>
        <td style="text-align: right;"><b>{{ project.billable_total|money }}</b></td>
        <td></td>
      </tr>
    {% endif %}
    </tbody>
  </table>
  <a href="{% url 'job.create' project.id %}">{% trans "Create" %}</a>


  <h2 class="sub-header">{% trans "Proposals" %}</h2>
  <table class="table table-striped">
    <thead>
    <tr>
      <th>#</th>
      <th>{% trans 'Status' %}</th>
      <th>{% trans 'Jobs' %}</th>
      <th>{% trans 'Amount' %}</th>
      <th>{% trans 'Created On' %}</th>
      <th>{% trans 'Notes' %}</th>
      <th>{% trans 'Download' %}</th>
      <th>{% trans 'Actions' %}</th>
    </tr>
    </thead>
    <tbody>
    {% for doc in proposals %}
      <tr>
        <td>{{ doc.id }}</td>
        <td>{{ doc.get_status_display }}</td>
        <td>
          {% for job in doc.jobs.all %}
            {{ job.code }} {{ job }}<br/>
          {% endfor %}
        </td>
        <td style="text-align: right; white-space: nowrap;">{{ doc.json.total_gross|money }}</td>
        <td>{{ doc.created_on|localize }}</td>
        <td>{{ doc.notes }}</td>
        <td style="min-width: 100px;">
          <div class="btn-group">
            <a class="btn btn-default" href="{% url 'proposal.pdf' project.id 'email' doc.id %}">{% trans 'PDF' %}</a>
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" role="menu">
              <li><a href="{% url 'proposal.pdf' project.id 'email' doc.id %}">{% trans 'Email PDF' %}</a></li>
              <li><a href="{% url 'proposal.pdf' project.id 'print' doc.id %}">{% trans 'Print PDF' %}</a></li>
              <li><a href="{% url 'proposal.pdf' project.id 'email' doc.id %}?with_lineitems=1">{% trans 'with Line Items Email' %}</a></li>
              <li><a href="{% url 'proposal.pdf' project.id 'print' doc.id %}?with_lineitems=1">{% trans 'with Line Items Print' %}</a></li>
            </ul>
          </div>
        </td>
        <td>
          {% for state in doc.get_available_status_transitions %}
            <a href="{% url 'proposal.transition' project.id doc.id state.name %}">{{ state.custom.label }}</a>
          {% endfor %}
          {% if doc.status == doc.NEW %}
            <a href="{% url 'proposal.delete' project.id doc.id %}">{% trans "Delete" %}</a>
            <a href="{% url 'proposal.update' project.id doc.id %}">{% trans "Edit" %}</a>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  {% if project.has_jobs_for_proposal %}
    <a href="{% url 'proposal.create' project.id %}">{% trans "Create" %}</a>
  {% else %}
    {% trans "No jobs available for new proposal." %}
    {% if not project_has_billable_contact %}
      <p>{% trans "No billable contact defined." %}</p>
    {% endif %}
  {% endif %}

  <style>
    .table > tbody > tr > td.tnx-table-label {
      vertical-align: bottom;
      text-align: right;
      font-weight: bold;
    }

    .add-total-amount {
      position: relative;
      font-weight: bold;
      text-align: right;
    }

    .add-total-amount:after {
      display: block;
      position: absolute;
      content: "+";
      top: 10px;
      right: -10px;
      font-size: 12px;
    }

    .equals-total-amount {
      position: relative;
      font-weight: bold;
      text-align: right;
    }

    .equals-total-amount:after {
      display: block;
      position: absolute;
      content: "=";
      top: 10px;
      right: -10px;
      font-size: 12px;
    }
  </style>


  <style>
  .invoice-columns {
    white-space: nowrap;
  }
  .invoice-columns * {
    white-space: normal;
  }
  .invoice-sequence {
    vertical-align: top;
    display: inline-block;
    width: 400px;
    padding-right: 40px;
  }
  .invoice {
    width: 100%;
  }
  </style>
  <h2 class="sub-header">{% trans "Invoices" %}</h2>
  <div class="invoice-columns clearfix">
    {% for parent_invoice in parent_invoices %}
    <div class="invoice-sequence">
      {% for invoice in parent_invoice.get_invoices %}
        {% include "document/invoice_card.html" with invoice=invoice %}
        {% if forloop.last %}
          {% if project_has_billable_contact %}
            {% if 'id' in invoice.json %}
            {% if invoice.status == invoice.SENT or invoice.status == invoice.PAID %}
              <a class="btn btn-default" href="{% url 'invoice.create' project.id %}?previous_invoice_id={{ invoice.id }}" style="width: 100%">
                {% trans 'Create next invoice in this sequence.' %}
              </a>
            {% else %}
              <p>{% trans 'Last invoice in sequence must be marked as sent before a new one can be created.' %}</p>
            {% endif %}
            {% endif %}
          {% else %}
            {% trans "No billable contact defined." %}
          {% endif %}
        {% endif %}
        {% empty %}
      {% endfor %}
    </div>
    {% endfor %}
    {% if project_has_billable_contact %}
      <div class="invoice-sequence">
        <a class="btn btn-default" href="{% url 'invoice.create' project.id %}" style="width: 100%">
          {% trans 'Start new invoice sequence.' %}
        </a>
      </div>
    {% else %}
      {% trans "No billable contact defined." %}
    {% endif %}
  </div>
  <br/>


  <style>
  .payment-table .job-row {
    font-size: 75%;
    color: gray;
    text-align: right;
  }
  .payment-table .job-row.last {
    border-bottom: 2px solid #ddd;
  }
  </style>
  <h2 class="sub-header">{% trans "Payments" %}</h2>
  <table class="table payment-table">
    <thead>
    <tr>
      <th>{% trans 'Date' %}</th>
      <th>{% trans 'Payment' %}</th>
      <th class="text-right">{% trans 'Applied' %}</th>
      <th class="text-right">{% trans 'Discount' %}</th>
      <th class="text-right">{% trans 'Adjustment' %}</th>
      <th class="text-right">{% trans 'Total Credit' %}</th>
      <th class="text-right" colspan="3">{% trans 'Actions' %}</th>
    </tr>
    </thead>
    <tbody>
    {% for transaction in transaction_report.transactions %}
      {% if transaction.type == 'payment' %}
      <tr>
        <td>{{ transaction.date|localize }}</td>
        <td>{{ transaction.payment_received|negate|money }}</td>
        <td class="text-right">{{ transaction.payment_applied_gross|negate|money }}</td>
        <td class="text-right">{{ transaction.discount_applied_gross|negate|money }}</td>
        <td class="text-right">{{ transaction.adjustment_applied_gross|negate|money }}</td>
        <td class="text-right">{{ transaction.gross|negate|money }}</td>
        <td class="text-right">
          {% if not transaction.is_reconciled %}
            <a href="{% url 'payment.delete' project.id transaction.id %}">{% trans "Delete" %}</a>
          {% endif %}
        </td>
      </tr>
      {% for job in transaction.jobs.values %}
        <tr class="job-row {% if forloop.last %}last{% endif %}">
          <td colspan="2">{{ job.name }}</td>
          <td>{{ job.payment_applied_gross|negate|money }}</td>
          <td>{{ job.discount_applied_gross|negate|money }}</td>
          <td>{{ job.adjustment_applied_gross|negate|money }}</td>
          <td>{{ job.gross|negate|money }}</td>
          <td></td>
        </tr>
      {% endfor %}
      {% endif %}
    {% endfor %}
    </tbody>
  </table>
  <a href="{% url 'payment.create' project.id %}">{% trans "Add Payment" %}</a>


  <h2 class="sub-header">{% trans "Refunds" %}</h2>
  <table class="table refund-table">
    <thead>
    <tr>
      <th>{% trans 'Date' %}</th>
      <th class="text-right">{% trans 'Refund' %}</th>
      <th>{% trans 'Download' %}</th>
      <th>{% trans 'Actions' %}</th>
    </tr>
    </thead>
    <tbody>
    {% for refund in project.refunds.all %}
      <tr>
        <td>{{ refund.document_date|localize }}</td>
        <td class="text-right">{{ refund.json.amount|money }}</td>
        <td style="min-width: 100px;">
          <div class="btn-group">
            <button type="button" class="btn btn-default">{% trans 'PDF' %}</button>
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" role="menu">
              <li><a href="{% url 'refund.pdf' project.id 'email' refund.id %}">{% trans 'Email PDF' %}</a></li>
              <li><a href="{% url 'refund.pdf' project.id 'print' refund.id %}">{% trans 'Print PDF' %}</a></li>
            </ul>
          </div>
        </td>
        <td class="text-right">
          <a href="{% url 'refund.delete' project.id refund.id %}">{% trans "Delete" %}</a>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <a href="{% url 'refund.create' project.id %}">{% trans "Add Refund" %}</a>


  <h2 class="sub-header">{% trans "Contacts" %}</h2>
  <table class="table table-striped">
    <thead>
    <tr>
      <th>#</th>
      <th>{% trans 'Name' %}</th>
      <th>{% trans 'Address Label' %}</th>
      <th>{% trans 'Association' %}</th>
      <th>{% trans 'Billable' %}</th>
      <th>{% trans 'Actions' %}</th>
    </tr>
    </thead>
    <tbody>
    {% for contact in project_contacts %}
      <tr>
        <td>{{ contact.id }}</td>
        <td><a href="{% url 'contact.view' contact.contact.id %}">{{ contact.contact }}</a></td>
        <td><pre>{{ contact.contact.address_label }}</pre></td>
        <td>{{ contact.get_association_display }}</td>
        <td>{{ contact.is_billable|yesno }}</td>
        <td>
          {% if not contact.is_billable %}
            <a href="{% url 'project.contact.billable' project.id contact.id %}">{% trans "Set Billable" %}</a>
            <a href="{% url 'project.contact.remove' project.id contact.id %}">{% trans "Remove" %}</a>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <a href="{% url 'project.contact.add' project.id %}">{% trans "Add" %}</a>


  <h2 class="sub-header">{% trans "Job Sites" %}</h2>
  <table class="table table-striped">
    <thead>
    <tr>
      <th>#</th>
      <th>{% trans 'Name' %}</th>
      <th>{% trans 'Address' %}</th>
      <th>{% trans 'City' %}</th>
      <th>{% trans 'Latitude' %} / {% trans 'Longitude' %}</th>
      <th>{% trans 'Actions' %}</th>
    </tr>
    </thead>
    <tbody>
    {% for site in jobsites %}
      <tr>
        <td>{{ site.id }}</td>
        <td>{{ site }}</td>
        <td>{{ site.address }}</td>
        <td>{{ site.city }}</td>
        <td>{{ site.latitude }}<br/>{{ site.longitude }}</td>
        <td>
          <a href="{% url 'jobsite.edit' project.id site.id %}">{% trans "Edit" %}</a>
          {% if jobsites_count > 1 %}
            <a href="{% url 'jobsite.delete' project.id site.id %}">{% trans "Delete" %}</a>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <a href="{% url 'jobsite.create' project.id %}">{% trans "Create" %}</a>
{% endblock %}
