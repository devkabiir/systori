{% extends "project.html" %}
{% load i18n l10n customformatting %}

{% block content %}
<h2 class="sub-header">{% trans "Jobs" %}</h2>
<div class="table-responsive">
  <table class="table table-striped">
    <thead>
      <tr>
        <th style="width: 30px;"><span class="glyphicon glyphicon-sort"></span></th>
        <th>{% trans "Name" %}</th>
        <th>{% trans "Status" %}</th>
        <th style="text-align: right; padding-right: 100px; width: 200px;">{% trans "Total" %}</th>
        <th>{% trans "Billing Method" %}</th>
        <th>{% trans "Billable Amount" %}</th>
        <th>{% trans "Actions" %}</th>
      </tr>
    </thead>
    <tbody id="job-table">
      {% for job in project.jobs.all %}
      <tr data-move="{% url 'api_dispatch_move' 'v1' 'job' job.id %}">
        <td style="cursor: pointer;" class="handle"><span class="glyphicon glyphicon-menu-hamburger"></span></td>
        <td><a href="{% url 'tasks' project.id job.id %}">{{ job }}</a></td>
        <td>{{ job.get_status_display }}</td>
        <td style="text-align: right;">
          {{ job.estimate_total|money }} &nbsp;
          <div class="btn-group">
            <a class="btn btn-default btn-xs" href="{% url 'job.estimate' project.id job.id 'increase' %}" title="{% blocktrans with percent=job.ESTIMATE_INCREMENT_DISPLAY %}Increase estimate by {{ percent }}.{% endblocktrans %}"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></a>
            <a class="btn btn-default btn-xs" href="{% url 'job.estimate' project.id job.id 'decrease' %}" title="{% blocktrans with percent=job.ESTIMATE_INCREMENT_DISPLAY %}Decrease estimate by {{ percent }}.{% endblocktrans %}"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></a>
            <a class="btn btn-default btn-xs" href="{% url 'job.estimate' project.id job.id 'reset' %}" title="{% trans 'Reset estimate to original amount.' %}"><span class="glyphicon glyphicon-unchecked" aria-hidden="true"></span></a>
          </div>
        </td>
        <td>{{ job.get_billing_method_display }}</td>
        <td>{{ job.billable_total|money }}</td>
        <td>
          {% for state in job.get_available_status_transitions %}
            <a href="{% url 'job.transition' project.id job.id state.name %}">{{ state.custom.label }}</a>
          {% endfor %}
          {% if job.status == job.DRAFT %}
          <a href="{% url 'job.edit' project.id job.id %}">{% trans "Edit" %}</a>
          <a href="{% url 'job.delete' project.id job.id %}">{% trans "Delete" %}</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <a href="{% url 'job.create' project.id %}">{% trans "Create" %}</a>
</div>


<h2 class="sub-header">{% trans "Proposals" %}</h2>
<div class="table-responsive">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>#</th>
        <th>{% trans 'Status' %}</th>
        <th>{% trans 'Jobs' %}</th>
        <th>{% trans 'Amount' %}</th>
        <th>{% trans 'Created On' %}</th>
        <th>{% trans 'Notes' %}</th>
        <th>{% trans 'Download' %}</th>
        <th>{% trans 'Actions' %}</th>
      </tr>
    </thead>
    <tbody>
      {% for doc in project.proposals.all %}
      <tr>
        <td>{{ doc.id }}</td>
        <td>{{ doc.get_status_display }}</td>
        <td>
        {% for job in doc.jobs.all %}
          {{ job }}<br />
        {% endfor %}
        </td>
        <td>{{ doc.amount|money }}</td>
        <td>{{ doc.created_on|localize }}</td>
        <td>{{ doc.notes }}</td>
        <td>
          <a href="{% url 'proposal.pdf' project.id 'email' doc.id %}">{% trans 'Email PDF' %}</a>
          <a href="{% url 'proposal.pdf' project.id 'print' doc.id %}">{% trans 'Print PDF' %}</a>
        </td>
        <td>
          {% for state in doc.get_available_status_transitions %}
            <a href="{% url 'proposal.transition' project.id doc.id state.name %}">{{ state.custom.label }}</a>
          {% endfor %}
          {% if doc.status == doc.NEW %}
          <a href="{% url 'proposal.delete' project.id doc.id %}">{% trans "Delete" %}</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% if project.has_jobs_for_proposal %}
    <a href="{% url 'proposal.create' project.id %}">{% trans "Create" %}</a>
  {% else %}
    {% trans "No jobs available for new proposal." %}
    {% if not project.has_billable_contact %}
    <p>{% trans "No billable contact defined." %}</p>
    {% endif %}
  {% endif %}
</div>

<style>
.table>tbody>tr>td.tnx-table-label {
    vertical-align: bottom;
    text-align: right;
    font-weight: bold;
}
.add-total-amount {
  position: relative;
  font-weight: bold;
  text-align: right;
}
.add-total-amount:after {
  display: block;
  position: absolute;
  content: "+";
  top: 10px;
  right: -10px;
  font-size: 12px;
}
.equals-total-amount {
  position: relative;
  font-weight: bold;
  text-align: right;
}
.equals-total-amount:after {
  display: block;
  position: absolute;
  content: "=";
  top: 10px;
  right: -10px;
  font-size: 12px;
}
</style>


<h2 class="sub-header">{% trans "Transactions" %}</h2>
<table class="table">
<thead>
  <tr>
    <th>{% trans 'Status' %}</th>
    <th>{% trans 'Date' %}</th>
    <th>{% trans 'Transaction' %}</th>
    <th class="text-right">{% trans 'Invoiced' %}</th>
    <th class="text-right">{% trans 'Debit' %}</th>
    <th class="text-right">{% trans 'Credit' %}</th>
    <th class="text-right" colspan="3">{% trans 'Actions' %}</th>
  </tr>
</thead>
<tbody>
{% for record_type, date, record in transactions %}
  {% if record_type == "invoice" %}
  <tr class="info">
    <td>{{ record.get_status_display }}</td>
    <td>{{ record.document_date|localize }}</td>
    <td>{% trans 'Invoice' %} {{ record.invoice_no }}</td>
    <td align="right">{{ record.amount|money }}</td>
    <td align="right">&nbsp;</td>
    <td align="right">&nbsp;</td>
    <td align="right" colspan="3">
      <a href="{% url 'invoice.pdf' project.id 'email' record.id %}">{% trans 'Email PDF' %}</a>
      <a href="{% url 'invoice.pdf' project.id 'print' record.id %}">{% trans 'Print PDF' %}</a>
      &nbsp; | &nbsp; 
      {% for state in record.get_available_status_transitions %}
        <a href="{% url 'invoice.transition' project.id record.id state.name %}">{{ state.custom.label }}</a>
      {% endfor %}
      {% if record.status == record.NEW %}
      <a href="{% url 'invoice.delete' project.id record.id %}">{% trans "Delete" %}</a>
      {% endif %}
    </td>
  </tr>
  {% elif record_type == "debit" %}
  <tr>
    <td>&nbsp;</td>
    <td>{{ record.received_on|localize }}</td>
    <td>{% trans 'Debit for work completed to date.' %}</td>
    <td align="right">&nbsp;</td>
    <td align="right">{{ record.amount|money }}</td>
    <td align="right">&nbsp;</td>
    <td colspan="3">&nbsp;</td>
  </tr>
  {% elif record_type == "payment" %}
  <tr class="success">
    <td>&nbsp;</td>
    <td>{{ record.received_on|localize }}</td>
    <td>{% trans 'Payment' %}</td>
    <td align="right">&nbsp;</td>
    <td align="right">&nbsp;</td>
    <td align="right">{{ record.amount|money }}</td>
    <td align="right" colspan="3">
      {% if not record.transaction.is_reconciled %}
      <a href="{% url 'payment.delete' project.id record.transaction.id %}">{% trans "Delete" %}</a>
      {% endif %}
    </td>
  </tr>
  {% elif record_type == "discount" %}
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>{% trans 'Discount' %}</td>
    <td align="right">&nbsp;</td>
    <td align="right">&nbsp;</td>
    <td align="right">{{ record.amount|money }}</td>
    <td colspan="3">&nbsp;</td>
  </tr>
  {% endif %}
{% endfor %}
  <tr>
    <td colspan="4">&nbsp;<br />&nbsp;</td>
    <td class="tnx-table-label">{% trans 'Debits' %}</td>
    <td class="tnx-table-label">{% trans 'Credits' %}</td>
    <td class="tnx-table-label">{% trans 'Balance' %}</td>
    <td class="tnx-table-label">{% trans 'Debitable' %}</td>
    <td class="tnx-table-label">{% trans 'Invoiceable' %}</td>
  </tr>
  <tr>
    <td colspan="4">
      {% if project.is_billable and project.has_billable_contact %}
        {% if project.new_amount_with_balance > 0 %}
            <a href="{% url 'invoice.create' project.id %}">
              {% with balance=project.new_amount_with_balance|money %}
              
              {% if project.new_amount_to_debit > 0 %}
                  {% blocktrans with new_amount=project.new_amount_to_debit|money balance=balance %}Debit {{ new_amount }} for newly finished work and create a new invoice for {{ balance }}{% endblocktrans %}
              {% else %}
                  {% blocktrans with balance=balance %}Create a new invoice for {{ balance }}{% endblocktrans %}
              {% endif %}
              {% endwith %}
            </a> &nbsp;
        {% else %}
            {% trans "No previous balance or new work available for invoicing." %}
        {% endif %}
      {% else %}
        {% trans "No jobs available to invoice." %}
        {% if not project.has_billable_contact %}
          {% trans "No billable contact defined." %}
        {% endif %}
      {% endif %}
      | &nbsp; <a href="{% url 'payment.create' project.id %}">{% trans "Add Payment" %}</a>
    </td>
    <td class="add-total-amount">{{ project.account.debits.total|money }}</td>
    <td class="equals-total-amount">{{ project.account.credits.total|money }}</td>
    <td class="add-total-amount">{{ project.account.balance|money }}</td>
    <td class="equals-total-amount">{{ project.new_amount_to_debit|money }}</td>
    <td align="right" style="font-weight: bold;">{{ project.new_amount_with_balance|money }}</td>
  </tr>
</tbody>
</table>
<br />


<h2 class="sub-header">{% trans "Evidences" %}</h2>
<div  class="table-responsive">
  <table  class="table table-striped">
    <thead>
      <tr>
        <th>{% trans 'Jobs' %}</th>
        <th>{% trans 'Created On' %}</th>
        <th>{% trans 'Download' %}</th>
        <th>{% trans 'Actions' %}</th>
      </tr>
    </thead>
    <tbody>
      {% for doc in project.evidences.all %}
      <tr>
        <td>
        {% for job in doc.jobs.all %}
          {{ job }}<br />
        {% endfor %}
        </td>
        <td>{{ doc.created_on|localize }}</td>
         <td>
          <a href="{% url 'evidence.pdf' project.id 'print' doc.id %}">{% trans 'PDF' %}</a>
        </td>
        <td>
          <a href="{% url 'evidence.delete' project.id doc.id %}">{% trans "Delete" %}</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% if project.has_jobs_for_invoice %}
    <a href="{% url 'evidence.create' project.id %}">{% trans "Create" %}</a>
  {% else %}
    <p>{% trans "No jobs available to invoice." %}</p>
    {% if not project.has_billable_contact %}
    <p>{% trans "No billable contact defined." %}</p>
    {% endif %}
  {% endif %}
</div>


<h2 class="sub-header">{% trans "Contacts" %}</h2>
<div class="table-responsive">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>#</th>
        <th>{% trans 'Name' %}</th>
        <th>{% trans 'Association' %}</th>
        <th>{% trans 'Billable' %}</th>
        <th>{% trans 'Actions' %}</th>
      </tr>
    </thead>
    <tbody>
      {% for contact in project.project_contacts.all %}
      <tr>
        <td>{{ contact.id }}</td>
        <td><a href="{% url 'contact.view' contact.contact.id %}">{{ contact.contact }}</a></td>
        <td>{{ contact.get_association_display }}</td>
        <td>{{ contact.is_billable|yesno }}</td>
        <td>
          {% if not contact.is_billable %}
            <a href="{% url 'project.contact.billable' project.id contact.id %}">{% trans "Set Billable" %}</a>
            <a href="{% url 'project.contact.remove' project.id contact.id %}">{% trans "Remove" %}</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <a href="{% url 'project.contact.add' project.id %}">{% trans "Add" %}</a>
</div>


<h2 class="sub-header">{% trans "Job Sites" %}</h2>
<div class="table-responsive">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>#</th>
        <th>{% trans 'Name' %}</th>
        <th>{% trans 'Address' %}</th>
        <th>{% trans 'City' %}</th>
        <th>{% trans 'Latitude' %} / {% trans 'Longitude' %}</th>
        <th>{% trans 'Actions' %}</th>
      </tr>
    </thead>
    <tbody>
      {% with jobsite_count=project.jobsites.count %}
      {% for site in project.jobsites.all %}
      <tr>
        <td>{{ site.id }}</td>
        <td>{{ site }}</td>
        <td>{{ site.address }}</td>
        <td>{{ site.city }}</td>
        <td>{{ site.latitude }}<br />{{ site.longitude }}</td>
        <td>
          <a href="{% url 'jobsite.edit' project.id site.id %}">{% trans "Edit" %}</a>
          {% if jobsite_count > 1 %}
          <a href="{% url 'jobsite.delete' project.id site.id %}">{% trans "Delete" %}</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      {% endwith %}
    </tbody>
  </table>
  <a href="{% url 'jobsite.create' project.id %}">{% trans "Create" %}</a>
</div>
{% endblock %}

{% block extra_js%}
<script type="text/javascript">
$("#job-table").sortable({
		handle: ".handle",
    update: function(event, ui) {
      $.ajax({
        type: 'GET',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        data: {'position': ui.item.index()},
        url: ui.item.data('move'),
        async: false
      });
    }
});
</script>
{% endblock extra_js%}
