{% extends "project.html" %}
{% load i18n bootstrap staticfiles customformatting %}

{% block sidebar %}{% include "project/sidebar.html" with section='invoices' %}{% endblock %}

{% block content %}
  <form role="form" method="post">{% csrf_token %}

      <h2 class="sub-header">{% trans "Invoice" %}</h2>
      {{ form.invoice_form|bootstrap }}

      <div class="form-group {% if form.non_form_errors %}has-error{% endif %}">
      {{ form.management_form }}

      <style>

        tr > .job-estimated,
        tr > .job-completed,
        tr > .job-itemized,
        tr > .job-debited,
        tr > .job-amount-net {
          text-align: right;
          min-width: 80px;
        }

        tr > th.job-flat {
          text-align: center;
          width: 300px;
        }

        tr > .job-debited {
          border-right: 2px solid #ddd;
        }

        tr > .job-name {
          min-width: 180px!important;
        }

        tr > .job-amount-net > input.form-control {
          display: inline-block;
          margin-top: -6px;
          width: 100px;
          text-align: right;
        }

        tr > td.job-itemized > a {
          color: black;
          background-color: transparent;
          display: block;
          text-align: right;
          height: 100%;
        }
        tr > td.job-itemized > a:hover {
          color: #fff;
          background-color: #e6e6e6;
        }

        .job-row:not(.invoiced) {
          color: lightgray;
        }

        textarea.job-override-comment {
          opacity: 1;
          height: 100px;
          width: 100%;
          background-color: inherit;
          transition: all 0.5s ease 0.15s;
        }

        .job-row:not(.invoiced) textarea.job-override-comment,
        .job-row:not(.override) textarea.job-override-comment {
          opacity: 0;
          height: 1px;
          margin-top: -10px;
        }

        .job-row .itemized-icon {
          display: none;
        }
        .job-row.override .itemized-icon.glyphicon-tag,
        .job-row.itemized .itemized-icon.glyphicon-list {
          display: inline-block;
        }

      </style>
      <h2 class="sub-header">{% trans "Debits" %}</h2>
      <table is="invoice-table" class="table table-striped">
        <thead>
        <tr>
          <th class="job-invoiced"></th>
          <th class="job-name">{% trans 'Job' %}</th>
          <th class="job-estimated">{% trans 'Estimate' %}</th>
          <th class="job-completed">{% trans 'Progress' %}</th>
          <th class="job-debited">{% trans 'Invoiced' %}</th>
          <th class="job-flat"><span class="glyphicon glyphicon-tag" aria-hidden="true"></span> {% trans 'Flat' %}</th>
          <th class="job-itemized"><span class="glyphicon glyphicon-list" aria-hidden="true"></span> {% trans 'Itemized' %}</th>
          <th class="job-amount-net">{% trans 'This Invoice' %}</th>
        </tr>
        </thead>
        <tbody>
        {% for debit_form in form.forms %}
          <tr is="invoice-debit" class="job-row {% if debit_form.is_invoiced.value %}invoiced{% endif %} {% if debit_form.is_override.value == 'True' %}override{% elif debit_form.debit_amount.net > 0 and debit_form.debit_amount.net == debit_form.billable_amount.net %}itemized{% endif %}">
            <td class="job-invoiced">{{ debit_form.is_invoiced }}</td>
            <td class="job-name">{{ debit_form.job }}{{ debit_form.initial.job.name }}</td>
            <td class="job-estimated" data-amount="{{ debit_form.latest_estimate.net }}">
              {{ debit_form.latest_estimate.net|ubrdecimal:2 }}
            </td>
            <td class="job-completed" data-amount="{{ debit_form.latest_itemized.net }}">
              {{ debit_form.latest_itemized.net|ubrdecimal:2 }}<br />
              {{ debit_form.latest_percent_complete }}%
            </td>
            <td class="job-debited" data-amount="{{ debit_form.base_debited.net }}">
              {{ debit_form.base_debited.net|ubrdecimal:2 }}<br />
            </td>
            <td class="job-flat" data-amount="{{ debit_form.base_debited.net }}">
                <input type="range" min="0" max="100" value="{{ debit_form.new_debited_percent }}" step="1" {% if not debit_form.is_invoiced.value %}disabled="disabled"{% endif %} />
                <div class="btn-group btn-group-justified">
                {% for percent in PERCENT_RANGE %}
                  <a class="btn btn-default btn-xs percent-button {% if not debit_form.is_invoiced.value %}disabled{% endif %}" data-percent="{{ percent }}">{{ percent }}%</a>
                {% endfor %}
                </div>
            </td>
            <td class="job-itemized">
              <a data-amount="{{ debit_form.billable_amount.net }}"
                 class="btn {% if not debit_form.is_invoiced.value %}disabled{% endif %}">
              {% if debit_form.billable_amount.net < 0 %}<span class="text-danger">{% endif %}
              {{ debit_form.billable_amount.net|ubrdecimal:2 }}
              {% if debit_form.billable_amount.net < 0 %}</span>{% endif %}
              </a>
            </td>
            <td class="job-amount-net {% if debit_form.amount_net.errors %}has-error bg-danger{% endif %}">

              <span class="glyphicon glyphicon-tag itemized-icon" aria-hidden="true"></span>
              <span class="glyphicon glyphicon-list itemized-icon" aria-hidden="true"></span>
              {{ debit_form.amount_net }}
              {% for error in debit_form.amount_net.errors %}
                <p class="help-block">{{ error }}</p>
              {% endfor %}

            </td>
            <td class="job-comment {% if debit_form.override_comment.errors %}has-error bg-danger{% endif %}">
              {{ debit_form.is_override }}
              {{ debit_form.override_comment }}
              {% for error in debit_form.override_comment.errors %}
                <p class="help-block">{{ error }}</p>
              {% endfor %}
            </td>
          </tr>
        {% endfor %}
          <tr class="job-table-totals">
            <td class="job-invoiced"></td>
            <td class="job-name"></td>
            <td class="job-estimated"></td>
            <td class="job-completed"></td>
            <td class="job-debited"></td>
            <td class="job-flat"></td>
            <td class="job-itemized"></td>
            <td class="job-amount-net">{{ form.debit_total.net|ubrdecimal:2 }}</td>
            <td class="job-comment"></td>
          </tr>
        </tbody>
      </table>
      {% for error in form.non_form_errors %}
        <span class="help-block ">{{ error }}</span>
      {% endfor %}
      </div>

      <div class="form-group">
        <button type="submit" class="btn btn-primary" value="{% trans 'Save' %}">{% trans 'Save' %}</button>
      </div>
  </form>
{% endblock %}

{% block extra_js %}
  <script type="text/javascript">
    $('[name="doc_template"]').on('change', function () {
      var templateid = this.value;
      if (templateid) {
        $.ajax({
          type: 'GET',
          headers: {'X-CSRFToken': '{{ csrf_token }}'},
          dataType: 'json',
          data: {'templateid': templateid},
          url: "{% url 'api_dispatch_document_template' 'v1' 'project' project.id %}",
          async: false
        }).done(function (template) {
          $('[name="header"]').val(template['header']);
          $('[name="footer"]').val(template['footer']);
        });
      }
    });
  </script>
  <script type="application/dart" src="{% static "dart/invoice_editor.dart" %}"></script>
  <script src="{% static "dart/packages/web_components/webcomponents.min.js" %}"></script>
  <script src="{% static "dart/packages/web_components/dart_support.js" %}"></script>
  <script src="{% static "dart/packages/browser/dart.js" %}"></script>
{% endblock extra_js %}